<!-- Page Header -->
<app-page-header 
  title="All Tasks" 
  subtitle="View and manage all your tasks across projects"
  [actions]="headerActions"
  [showFilters]="showFilters">
  
  <!-- Filters Panel -->
  <div class="card card-notion">
    <div class="card-body">
      <form [formGroup]="filterForm" class="row g-3">
        <div class="col-md-3">
          <label for="projectFilter" class="form-label small fw-medium">Project</label>
          <select id="projectFilter" formControlName="project" class="form-select form-select-sm">
            <option value="">All Projects</option>
            <option *ngFor="let project of projects()" [value]="project.id">
              {{ project.name }}
            </option>
          </select>
        </div>

        <div class="col-md-2">
          <label for="statusFilter" class="form-label small fw-medium">Status</label>
          <select id="statusFilter" formControlName="status" class="form-select form-select-sm">
            <option value="">All Statuses</option>
            <option value="CREATED">Created</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="BLOCKED">Blocked</option>
            <option value="TESTING">Testing</option>
            <option value="READY_TO_FINISH">Ready to Finish</option>
            <option value="FINISHED">Finished</option>
          </select>
        </div>

        <div class="col-md-2">
          <label for="priorityFilter" class="form-label small fw-medium">Priority</label>
          <select id="priorityFilter" formControlName="priority" class="form-select form-select-sm">
            <option value="">All Priorities</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>

        <div class="col-md-2">
          <label for="assigneeFilter" class="form-label small fw-medium">Assignee</label>
          <select id="assigneeFilter" formControlName="assignee" class="form-select form-select-sm">
            <option value="">All Assignees</option>
            <!-- TODO: Add users -->
          </select>
        </div>

        <div class="col-md-3">
          <label for="searchFilter" class="form-label small fw-medium">Search</label>
          <input type="text" id="searchFilter" formControlName="search" 
                 class="form-control form-control-sm" placeholder="Search tasks...">
        </div>
      </form>
      
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" (click)="clearFilters()">
            <i class="fas fa-times me-1"></i>Clear All
          </button>
        </div>
        <small class="text-muted">{{ filteredTasksCount() }} tasks shown</small>
      </div>
    </div>
  </div>
</app-page-header>

<!-- Loading State -->
<div class="d-flex justify-content-center align-items-center" style="height: 400px;" *ngIf="loading()">
  <div class="text-center">
    <div class="spinner-border text-primary mb-3" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted">Loading tasks...</p>
  </div>
</div>

<!-- Error State -->
<div class="container-fluid px-4" *ngIf="error()">
  <div class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>{{ error() }}
  </div>
</div>

<!-- Main Content -->
<div class="container-fluid px-4 py-4" *ngIf="!loading() && !error()">
  <!-- Task Summary Cards -->
  <div class="row g-4 mb-4">
    <div class="col-sm-6 col-lg-2">
      <div class="card card-notion text-center">
        <div class="card-body">
          <div class="fs-4 fw-bold text-secondary">{{ getTasksByStatus('CREATED').length }}</div>
          <small class="text-muted">Created</small>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-2">
      <div class="card card-notion text-center">
        <div class="card-body">
          <div class="fs-4 fw-bold text-primary">{{ getTasksByStatus('IN_PROGRESS').length }}</div>
          <small class="text-muted">In Progress</small>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-2">
      <div class="card card-notion text-center">
        <div class="card-body">
          <div class="fs-4 fw-bold text-danger">{{ getTasksByStatus('BLOCKED').length }}</div>
          <small class="text-muted">Blocked</small>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-2">
      <div class="card card-notion text-center">
        <div class="card-body">
          <div class="fs-4 fw-bold text-warning">{{ getTasksByStatus('TESTING').length }}</div>
          <small class="text-muted">Testing</small>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-2">
      <div class="card card-notion text-center">
        <div class="card-body">
          <div class="fs-4 fw-bold text-info">{{ getTasksByStatus('READY_TO_FINISH').length }}</div>
          <small class="text-muted">Ready to Finish</small>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-2">
      <div class="card card-notion text-center">
        <div class="card-body">
          <div class="fs-4 fw-bold text-success">{{ getTasksByStatus('FINISHED').length }}</div>
          <small class="text-muted">Finished</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Tasks Table -->
  <div class="card card-notion">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Task</th>
            <th>Project</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Assignee</th>
            <th>Due Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let task of getFilteredTasks()" 
              (click)="openTaskDetail(task)" 
              style="cursor: pointer;">
            <td>
              <div>
                <div class="fw-medium">{{ task.title }}</div>
                <small class="text-muted" *ngIf="task.description">
                  {{ task.description | slice:0:50 }}{{ task.description && task.description.length > 50 ? '...' : '' }}
                </small>
                <div class="mt-1" *ngIf="task.labels && task.labels.length > 0">
                  <span class="badge bg-light text-dark me-1" 
                        *ngFor="let label of task.labels.slice(0, 3)">{{ label }}</span>
                  <span class="badge bg-secondary" 
                        *ngIf="task.labels && task.labels.length > 3">+{{ task.labels.length - 3 }}</span>
                </div>
              </div>
            </td>
            <td>
              <span class="badge bg-primary">{{ getProjectName(task.projectId) }}</span>
            </td>
            <td>
              <span class="badge badge-status" 
                    [ngClass]="'status-' + task.status.toLowerCase().replace('_', '-')">
                {{ getStatusLabel(task.status) }}
              </span>
            </td>
            <td>
              <span class="badge" 
                    [ngClass]="{
                      'bg-danger': task.priority === 'high',
                      'bg-warning': task.priority === 'medium',
                      'bg-success': task.priority === 'low'
                    }">
                {{ task.priority | titlecase }}
              </span>
            </td>
            <td>
              <div class="d-flex align-items-center" *ngIf="task.assignedTo">
                <div class="task-assignee me-2">{{ getAssigneeInitials(task.assignedTo) }}</div>
                <span class="small">{{ getAssigneeName(task.assignedTo) }}</span>
              </div>
              <span class="text-muted small" *ngIf="!task.assignedTo">Unassigned</span>
            </td>
            <td>
              <span *ngIf="task.dueDate" [class]="getDueDateClass(task.dueDate)">
                {{ task.dueDate | date:'MMM d' }}
              </span>
              <span class="text-muted" *ngIf="!task.dueDate">No due date</span>
            </td>
            <td>
              <div class="dropdown" (click)="$event.stopPropagation()">
                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="dropdown">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" (click)="editTask(task)">Edit</a></li>
                  <li><a class="dropdown-item" (click)="assignTask(task)">Assign</a></li>
                  <li><a class="dropdown-item" (click)="changeStatus(task)">Change Status</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" (click)="deleteTask(task)">Delete</a></li>
                </ul>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Empty State -->
    <div class="text-center py-5" *ngIf="getFilteredTasks().length === 0">
      <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
      <h5>No Tasks Found</h5>
      <p class="text-muted">No tasks match your current filters.</p>
      <button class="btn btn-primary" (click)="clearFilters()">Clear Filters</button>
    </div>
    
    <!-- Pagination -->
    <div class="card-footer bg-transparent" *ngIf="getFilteredTasks().length > pageSize">
      <nav>
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">
            Showing {{ (currentPage - 1) * pageSize + 1 }} to {{ Math.min(currentPage * pageSize, getFilteredTasks().length) }} of {{ getFilteredTasks().length }} tasks
          </small>
          <div class="btn-group" role="group">
            <button class="btn btn-outline-secondary btn-sm" 
                    [disabled]="currentPage === 1"
                    (click)="currentPage = currentPage - 1">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm" 
                    [disabled]="currentPage * pageSize >= getFilteredTasks().length"
                    (click)="currentPage = currentPage + 1">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </nav>
    </div>
  </div>
</div>